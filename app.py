import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt
from datetime import datetime, timedelta

# === –ò–ù–¢–ï–†–§–ï–ô–° STREAMLIT ===
st.set_page_config(page_title="üìä ChannelPulseMetric", layout="wide", page_icon="üìà")
st.title("üìä ChannelPulseMetric ‚Äî –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –¥–ª—è –õ–Æ–ë–û–ì–û Telegram-–∫–∞–Ω–∞–ª–∞")
st.markdown("‚ú® **–ü–æ–ª—É—á–∏—Ç–µ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –æ—Ç—á—ë—Ç –∑–∞ 60 —Å–µ–∫—É–Ω–¥** ‚Äî –±–µ–∑ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏ –°–ú–°")

# –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫
st.markdown("""
<style>
    .stButton>button {
        background-color: #FF4B4B;
        color: white;
        border-radius: 8px;
        padding: 0.5rem 1rem;
        font-weight: bold;
    }
    .stButton>button:hover {
        background-color: #E63939;
    }
</style>
""", unsafe_allow_html=True)

# –ü–æ–ª–µ –≤–≤–æ–¥–∞
col1, col2 = st.columns([3, 1])
with col1:
    channel_input = st.text_input(
        "–í–≤–µ–¥–∏—Ç–µ @username –∫–∞–Ω–∞–ª–∞ –∏–ª–∏ —Å—Å—ã–ª–∫—É (–ø—Ä–∏–º–µ—Ä: habr_com)",
        "habr_com",
        help="–†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å –ø—É–±–ª–∏—á–Ω—ã–º–∏ –∫–∞–Ω–∞–ª–∞–º–∏"
    )

with col2:
    st.write("")
    st.write("")
    st.markdown("**–¢–µ—Å—Ç–æ–≤—ã–µ –∫–∞–Ω–∞–ª—ã:**")
    st.caption("habr_com, rian_ru, lentach")

# –û–±—Ä–∞–±–æ—Ç–∫–∞ username
channel_username = channel_input.strip().replace("https://t.me/", "").replace("@", "").split("?")[0]

if st.button("‚ú® –ü–æ–ª—É—á–∏—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –æ—Ç—á—ë—Ç", use_container_width=True):
    with st.spinner("üîç –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –∫–∞–Ω–∞–ª... (15-30 —Å–µ–∫—É–Ω–¥)"):
        try:
            # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã—Ö –¥–µ–º–æ-–¥–∞–Ω–Ω—ã—Ö
            if "habr_com" in channel_username:
                dates = [datetime.now() - timedelta(days=i) for i in range(7, 0, -1)]
                views = [15200, 14800, 16300, 9500, 22100, 28500, 19700]
                texts = [
                    "–†–∞–∑–±–æ—Ä —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∞ LangChain –¥–ª—è –ò–ò-—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏",
                    "–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è Python-–∫–æ–¥–∞: 7 –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤",
                    "–ù–µ–π—Ä–æ—Å–µ—Ç–∏ –≤ –º–µ–¥–∏—Ü–∏–Ω–µ: –∫–∞–∫ –ò–ò —Å–ø–∞—Å–∞–µ—Ç –∂–∏–∑–Ω–∏",
                    "–ü–æ—á–µ–º—É —è –ø–µ—Ä–µ—à—ë–ª —Å JavaScript –Ω–∞ Rust",
                    "–ê–Ω–∞–ª–∏–∑ —Ä—ã–Ω–∫–∞ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç –≤ 2026 –≥–æ–¥—É",
                    "–ö–∞–∫ –Ω–∞–ø–∏—Å–∞—Ç—å —Å–≤–æ—é –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—É—é —Å–∏—Å—Ç–µ–º—É —Å –Ω—É–ª—è",
                    "–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∏–ø–æ–≤ NVIDIA Blackwell: —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã"
                ]
                channel_title = "–•–∞–±—Ä"
            elif "rian_ru" in channel_username:
                dates = [datetime.now() - timedelta(days=i) for i in range(7, 0, -1)]
                views = [45200, 38700, 52100, 29800, 63400, 78900, 41200]
                texts = [
                    "–í–ª–∞–¥–∏–º–∏—Ä –ü—É—Ç–∏–Ω –ø—Ä–æ–≤—ë–ª –≤—Å—Ç—Ä–µ—á—É —Å –ª–∏–¥–µ—Ä–∞–º–∏ G20",
                    "–ù–æ–≤—ã–µ —Å–∞–Ω–∫—Ü–∏–∏ –ø—Ä–æ—Ç–∏–≤ –†–§: –∞–Ω–∞–ª–∏–∑ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏–π",
                    "–ö–æ—Å–º–∏—á–µ—Å–∫–∏–π –∫–æ—Ä–∞–±–ª—å ¬´–û—Ä—ë–ª¬ª —É—Å–ø–µ—à–Ω–æ —Å—Ç–∞—Ä—Ç–æ–≤–∞–ª",
                    "–†–æ—Å—Ç –í–í–ü –†–æ—Å—Å–∏–∏ –ø—Ä–µ–≤—ã—Å–∏–ª –ø—Ä–æ–≥–Ω–æ–∑—ã –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–≤",
                    "–ó–∞–ø—É—Å–∫ –ø–µ—Ä–≤–æ–π –ª–∏–Ω–∏–∏ ¬´–°–∏–ª—ã –°–∏–±–∏—Ä–∏ ‚Äî 2¬ª",
                    "–í—ã–±–æ—Ä—ã –ø—Ä–µ–∑–∏–¥–µ–Ω—Ç–∞: —è–≤–∫–∞ —Å–æ—Å—Ç–∞–≤–∏–ª–∞ 68%",
                    "–°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –≤–∞–∫—Ü–∏–Ω–∞ –æ—Ç –≥—Ä–∏–ø–ø–∞"
                ]
                channel_title = "–†–ò–ê –ù–æ–≤–æ—Å—Ç–∏"
            else:
                dates = [datetime.now() - timedelta(days=i) for i in range(7, 0, -1)]
                views = [1200, 950, 1500, 800, 2100, 3000, 1800]
                texts = ["–¢–µ—Å—Ç–æ–≤—ã–π –ø–æ—Å—Ç"] * 7
                channel_title = channel_username

            # –°–æ–∑–¥–∞–Ω–∏–µ DataFrame
            data = []
            for i in range(len(dates)):
                if i < len(views) and i < len(texts):
                    data.append({
                        "date": dates[i],
                        "views": views[i],
                        "text_preview": texts[i][:40] + "..." if i < len(texts) else "[–º–µ–¥–∏–∞]"
                    })

            df = pd.DataFrame(data)

            # –ì—Ä–∞—Ñ–∏–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
            fig, ax = plt.subplots(figsize=(12, 5))
            ax.plot(df['date'], df['views'], marker='o', color='#2E86AB', linewidth=2.5, markersize=8)
            ax.fill_between(df['date'], df['views'], color='#2E86AB', alpha=0.1)

            ax.set_title(f"–î–∏–Ω–∞–º–∏–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ @{channel_username} ({channel_title})", fontsize=16, pad=20)
            ax.set_xlabel("–î–∞—Ç–∞", fontsize=12)
            ax.set_ylabel("–ü—Ä–æ—Å–º–æ—Ç—Ä—ã", fontsize=12)
            ax.grid(True, linestyle='--', alpha=0.7)
            plt.xticks(rotation=35)
            plt.tight_layout()

            st.pyplot(fig)

            # –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏
            col1, col2, col3 = st.columns(3)
            with col1:
                st.metric("üìà –ü–∏–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤", f"{df['views'].max():,}")
            with col2:
                st.metric("üìâ –ú–∏–Ω–∏–º—É–º", f"{df['views'].min():,}")
            with col3:
                st.metric("üìä –°—Ä–µ–¥–Ω–µ–µ", f"{df['views'].mean():.0f}")

            # –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (—É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ)
            st.subheader("üí° –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏")

            avg_views = df['views'].mean()
            recent_avg = df['views'].tail(3).mean()
            overall_avg = df['views'].mean()

            if recent_avg < overall_avg * 0.7:
                st.warning(
                    "üî∏ **–ü–∞–¥–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏**: –ü–æ—Å–ª–µ–¥–Ω–∏–µ 3 –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –∏–º–µ—é—Ç –Ω–∞ 30% –º–µ–Ω—å—à–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤, —á–µ–º –≤ —Å—Ä–µ–¥–Ω–µ–º. –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –∏ –≤—Ä–µ–º—è –ø—É–±–ª–∏–∫–∞—Ü–∏–π.")
            elif avg_views < 1000:
                st.info(
                    "üî∏ **–ù–∏–∑–∫–∏–π –æ—Ö–≤–∞—Ç**: –°—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ –Ω–∏–∂–µ 1000. –ü—É–±–ª–∏–∫—É–π—Ç–µ –∫–æ–Ω—Ç–µ–Ω—Ç –≤ 18:00-22:00 ‚Äî —ç—Ç–æ —É–≤–µ–ª–∏—á–∏—Ç –æ—Ö–≤–∞—Ç –Ω–∞ 35% (–ø–æ –¥–∞–Ω–Ω—ã–º 2023 –≥.).")
            else:
                st.success(
                    "üî∏ **–°—Ç–∞–±–∏–ª—å–Ω–∞—è –¥–∏–Ω–∞–º–∏–∫–∞**: –í–∞—à –∫–∞–Ω–∞–ª –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ö–æ—Ä–æ—à–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã! –î–ª—è —Ä–æ—Å—Ç–∞ –¥–æ–±–∞–≤–ª—è–π—Ç–µ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤ (–æ–ø—Ä–æ—Å—ã, –≤–æ–ø—Ä–æ—Å—ã) ‚Äî —ç—Ç–æ –ø–æ–≤—ã—Å–∏—Ç –≤–æ–≤–ª–µ—á—ë–Ω–Ω–æ—Å—Ç—å –Ω–∞ 25%.")

            peak_day = df['date'].dt.day_name().mode()[0]
            if peak_day not in ["Saturday", "Sunday"]:
                st.write(
                    f"üî∏ **–ò–¥–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è**: {peak_day} ‚Äî –≤–∞—à –¥–µ–Ω—å —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é. –ü–µ—Ä–µ–Ω–µ—Å–∏—Ç–µ 70% –ø—É–±–ª–∏–∫–∞—Ü–∏–π –Ω–∞ —ç—Ç–æ –≤—Ä–µ–º—è.")

            # –ü—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é
            st.divider()
            st.markdown("""
            <div style="background-color: #FFF8E1; padding: 15px; border-radius: 10px; border-left: 4px solid #FFC107;">
                <h3>üöÄ –•–æ—Ç–∏—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç–∞–∫—É—é –∞–Ω–∞–ª–∏—Ç–∏–∫—É –¥–ª—è –≤–∞—à–µ–≥–æ –∫–∞–Ω–∞–ª–∞?</h3>
                <ul>
                    <li>üìÖ –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–µ –æ—Ç—á—ë—Ç—ã —Å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–º–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏</li>
                    <li>üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–∞–º–∏ –≤ –≤–∞—à–µ–π –Ω–∏—à–µ</li>
                    <li>ü§ñ –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø–∏–∫–∞—Ö –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</li>
                </ul>
                <h3>üî• –°–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ: <span style="color: #FF4B4B;">2990 ‚ÇΩ/–º–µ—Å</span> –≤–º–µ—Å—Ç–æ 4990 ‚ÇΩ</h3>
            </div>
            """, unsafe_allow_html=True)

            if st.button("‚úÖ –ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –¥–µ–º–æ-–¥–æ—Å—Ç—É–ø (–±–µ—Å–ø–ª–∞—Ç–Ω–æ –Ω–∞ 3 –¥–Ω—è)", key="demo_button"):
                st.success("üéâ –û—Ç–ª–∏—á–Ω–æ! –î–µ–º–æ-–∞–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω!")
                st.markdown("""
                **–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:**
                1. –ù–∞–ø–∏—à–∏—Ç–µ [@ChannelPulseMetric_bot](https://t.me/ChannelPulseMetric_bot) –≤ Telegram
                2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–¥ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏: `DEMO-2026-01-18`
                3. –ü–æ–ª—É—á–∏—Ç–µ –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –Ω–∞ 3 –¥–Ω—è
                """, unsafe_allow_html=True)
                st.balloons()

        except Exception as e:
            st.error(f"‚ùå –û—à–∏–±–∫–∞: {str(e)}")
            st.info("üí° –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤–≤–µ—Å—Ç–∏ `habr_com` –¥–ª—è —Ç–µ—Å—Ç–∞ –∏–ª–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.")

# –°–∞–π–¥–±–∞—Ä —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π
with st.sidebar:
    st.image("https://i.imgur.com/5GQZ8hL.png", width=200)
    st.title("üöÄ ChannelPulseMetric")
    st.subheader("–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ Telegram-–∫–∞–Ω–∞–ª–æ–≤")

    st.markdown("### ‚ñ∂Ô∏è –ö–∞–∫ –Ω–∞—á–∞—Ç—å")
    st.markdown("""
    1. **–í–≤–µ–¥–∏—Ç–µ username** –ª—é–±–æ–≥–æ –ø—É–±–ª–∏—á–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞
    2. **–ù–∞–∂–º–∏—Ç–µ ¬´–ü–æ–ª—É—á–∏—Ç—å –æ—Ç—á—ë—Ç¬ª**
    3. **–ü–æ–ª—É—á–∏—Ç–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏** –∑–∞ 60 —Å–µ–∫—É–Ω–¥
    """)

    st.divider()
    st.markdown("### üí° –°–æ–≤–µ—Ç—ã")
    st.markdown("""
    - –î–ª—è —Ç–µ—Å—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ: `habr_com`, `rian_ru`
    - –ö–∞–Ω–∞–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å **–ø—É–±–ª–∏—á–Ω—ã–º**
    - –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ –∫–∞–Ω–∞–ª—ã
    """)

    st.divider()
    st.markdown("### üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞")
    st.markdown("""
    - –ù–∞–ø–∏—à–∏—Ç–µ [@ChannelPulseMetric_bot](https://t.me/ChannelPulseMetric_bot)
    - Email: support@channelpulsemetric.com
    - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: [docs.channelpulsemetric.com](https://docs.channelpulsemetric.com)
    """, unsafe_allow_html=True)

    st.divider()
    st.caption("¬© 2026 ChannelPulseMetric. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.")

    # –í–∞–∂–Ω–æ–µ –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ –æ –¥–µ–º–æ-–≤–µ—Ä—Å–∏–∏
    st.info("""
    **‚ÑπÔ∏è –≠—Ç–æ –¥–µ–º–æ-–≤–µ—Ä—Å–∏—è**

    –í –ø–ª–∞—Ç–Ω–æ–π –≤–µ—Ä—Å–∏–∏ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ:
    - –ê–Ω–∞–ª–∏–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤–∞—à–µ–≥–æ –∫–∞–Ω–∞–ª–∞
    - –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
    - –ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ—Ç—á—ë—Ç—ã

    –î–µ–º–æ-—Ä–µ–∂–∏–º –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–∞.
    """)

# –°–∫—Ä—ã—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞
st.sidebar.markdown("""
<div style="position: fixed; bottom: 20px; width: 220px; text-align: center;">
    <small>–í–µ—Ä—Å–∏—è 1.0 ‚Ä¢ –î–µ–º–æ-—Ä–µ–∂–∏–º</small>
</div>
""", unsafe_allow_html=True)
